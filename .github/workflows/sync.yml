# ä¸ºè¿™ä¸ªå·¥ä½œæµå‘½å
name: sync.yml

on:
  # ä½ å¯ä»¥æ ¹æ®éœ€è¦ä¿®æ”¹è¿™ä¸ªæ—¶é—´
  schedule:
    - cron: '0 21 * * *'
  # å…è®¸ä½ ä»ä»“åº“çš„ Actions é¡µé¢æ‰‹åŠ¨è§¦å‘æ­¤å·¥ä½œæµ
  workflow_dispatch:

jobs:
  sync-with-upstream:
    # ä½¿ç”¨æœ€æ–°ç‰ˆçš„ Ubuntu è™šæ‹Ÿæœºä½œä¸ºè¿è¡Œç¯å¢ƒ
    runs-on: ubuntu-latest
    steps:
      # ç¬¬ä¸€æ­¥ï¼šæ£€å‡ºï¼ˆCheckoutï¼‰ä½ çš„ä»“åº“ä»£ç 
      # è¿™æ˜¯å®˜æ–¹æä¾›çš„ Actionï¼Œç”¨äºåœ¨è™šæ‹Ÿæœºä¸­æ‹‰å–ä½ çš„ä»£ç 
      - name: Checkout Your Repository
        uses: actions/checkout@v4
        with:
          # `fetch-depth: 0` ä¼šæ‹‰å–æ‰€æœ‰çš„ commit å†å²ï¼Œè¿™å¯¹äºåç»­çš„ merge æ“ä½œæ˜¯å¿…éœ€çš„
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # ç¬¬äºŒæ­¥ï¼šæ‰§è¡Œæ ¸å¿ƒè„šæœ¬ï¼šåŒæ­¥ä¸Šæ¸¸å¹¶ä¿ç•™ä¸ªäººæ•°æ®
      - name: Sync with Upstream and Preserve Data
        run: |
          # =================================================================
          # è„šæœ¬å¼€å§‹
          # =================================================================
          
          # è®¾ç½®è„šæœ¬åœ¨é‡åˆ°é”™è¯¯æ—¶ç«‹å³é€€å‡º
          set -e

          # é…ç½® git ç”¨æˆ·ä¿¡æ¯ï¼Œè¿™æ · Action æ‰èƒ½æ›¿ä½ æäº¤ä»£ç 
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'

          # --- 1. å¤‡ä»½ä½ çš„æ•°æ®æ–‡ä»¶ ---
          echo "Step 1: Backing up your data files..."
          # åˆ›å»ºä¸€ä¸ªä¸´æ—¶æ–‡ä»¶å¤¹æ¥å­˜æ”¾ä½ çš„ä¸ªäººæ•°æ®æ–‡ä»¶
          mkdir -p .sync_backup_temp
          # æŸ¥æ‰¾æ‰€æœ‰éœ€è¦ä¿ç•™çš„æ–‡ä»¶ï¼ˆpng, csv, json, iniï¼‰ï¼Œå¹¶å¤åˆ¶åˆ°ä¸´æ—¶æ–‡ä»¶å¤¹
          # -maxdepth 1 å‚æ•°ç¡®ä¿åªæŸ¥æ‰¾ä»“åº“æ ¹ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œé¿å…è¯¯æ“ä½œ
          find . -maxdepth 1 \( -name "*.png" -o -name "*.csv" -o -name "*.json" -o -name "*.ini" \) -exec echo "  > Backing up {}" \; -exec cp {} .sync_backup_temp/ \; 2>/dev/null || true
          echo "Backup complete."

          # --- 2. åŒæ­¥ä¸Šæ¸¸ä»“åº“ ---
          echo "Step 2: Syncing with upstream repository..."
          # æ·»åŠ æˆ‘çš„åŸä»“åº“åœ°å€ä½œä¸º"ä¸Šæ¸¸" (upstream)ï¼Œå¦‚æœå·²å­˜åœ¨åˆ™å¿½ç•¥é”™è¯¯
          git remote add upstream https://github.com/cli117/stock_monitor.git 2>/dev/null || echo "Upstream remote already exists"
          
          # ä»ä¸Šæ¸¸ä»“åº“æ‹‰å–æœ€æ–°çš„åŠŸèƒ½å’Œä»£ç 
          echo "Fetching from upstream..."
          git fetch upstream
          
          # æ£€æŸ¥ä¸Šæ¸¸åˆ†æ”¯æ˜¯å¦å­˜åœ¨ï¼ˆæ”¯æŒ main æˆ– masterï¼‰
          if git show-ref --verify --quiet refs/remotes/upstream/main; then
            UPSTREAM_BRANCH="upstream/main"
            echo "Using upstream/main branch"
          elif git show-ref --verify --quiet refs/remotes/upstream/master; then
            UPSTREAM_BRANCH="upstream/master"
            echo "Using upstream/master branch"
          else
            echo "âŒ Error: Neither main nor master branch found in upstream repository"
            echo "Available branches:"
            git branch -r | grep upstream/ || echo "No upstream branches found"
            exit 1
          fi

          # å°è¯•åˆå¹¶ï¼Œå¦‚æœæœ‰å†²çªåˆ™é€€å‡º
          echo "Attempting to merge $UPSTREAM_BRANCH..."
          if ! git merge $UPSTREAM_BRANCH --allow-unrelated-histories --no-edit; then
            echo "âŒ MERGE CONFLICT DETECTED!"
            echo "==================================="
            echo "Sync aborted due to merge conflicts."
            echo "Please resolve conflicts manually:"
            echo "1. Run: git status"
            echo "2. Resolve conflicts in affected files"
            echo "3. Run: git add <resolved-files>"
            echo "4. Run: git commit"
            echo "5. Run: git push"
            echo "==================================="
            
            # æ¸…ç†ï¼šå–æ¶ˆåˆå¹¶çŠ¶æ€
            git merge --abort 2>/dev/null || true
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶å¤¹
            rm -rf .sync_backup_temp
            
            # é€€å‡ºå¹¶æ ‡è®°ä¸ºå¤±è´¥
            exit 1
          fi
          
          echo "âœ… Merge successful - no conflicts detected"

          # --- 3. æ¢å¤ä½ çš„æ•°æ®æ–‡ä»¶ ---
          echo "Step 3: Restoring your data files..."
          # æ£€æŸ¥å¤‡ä»½æ–‡ä»¶å¤¹æ˜¯å¦ä¸ºç©º
          if [ -n "$(ls -A .sync_backup_temp/ 2>/dev/null)" ]; then
            # å¦‚æœä¸ä¸ºç©ºï¼Œå°±æŠŠå¤‡ä»½çš„æ–‡ä»¶å¤åˆ¶å›æ¥ï¼Œè¦†ç›–æ‰ä»ä¸Šæ¸¸åŒæ­¥è¿‡æ¥çš„ç‰ˆæœ¬
            cp -vf .sync_backup_temp/* . 2>/dev/null || echo "No files to restore"
            echo "âœ… Restore complete."
          else
            echo "â„¹ï¸  No data files needed to be restored."
          fi

          # --- 4. æ¸…ç†ä¸´æ—¶æ–‡ä»¶å¤¹ ---
          echo "Step 4: Cleaning up..."
          rm -rf .sync_backup_temp
          echo "âœ… Cleanup complete."

          # --- 5. æäº¤å¹¶æ¨é€æ›´æ–° ---
          echo "Step 5: Committing and pushing changes..."
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜åŠ¨ï¼ˆæ‹‰å–åˆ°çš„æ–°åŠŸèƒ½æˆ–ä½ æ¢å¤çš„æ•°æ®ï¼‰
          if git diff --quiet && git diff --staged --quiet; then
            echo "â„¹ï¸  Your repository is already up-to-date. No push needed."
          else
            echo "ğŸ“ Changes detected. Committing and pushing to your repository..."
            git add -A
            git commit -m "chore: Daily sync with upstream and preserve data [$(date +'%Y-%m-%d %H:%M:%S UTC')]"
            
            # æ¨é€æ›´æ”¹ï¼Œå¦‚æœå¤±è´¥åˆ™æŠ¥é”™
            if git push; then
              echo "âœ… Push successful!"
            else
              echo "âŒ Push failed!"
              exit 1
            fi
          fi

          echo "ğŸ‰ Sync completed successfully!"
          
          # =================================================================
          # è„šæœ¬ç»“æŸ
          # =================================================================
