# å·¥ä½œæµåç§°
name: Run Python Script

# å·¥ä½œæµçš„è§¦å‘æ¡ä»¶
on:
  # 1. å…è®¸æ‚¨åœ¨ GitHub é¡µé¢çš„ "Actions" æ ‡ç­¾ä¸‹æ‰‹åŠ¨ç‚¹å‡»è¿è¡Œ
  workflow_dispatch:
  
  # 2. å®šæ—¶è§¦å‘ (ä½¿ç”¨ Cron è¯­æ³•)
  schedule:
    # å·¥ä½œæ—¥ 22:00 UTC è¿è¡Œã€‚
    # - æ ‡å‡†æ—¶é—´æœŸé—´ (çº¦11æœˆ-3æœˆ): å¯¹åº”ç¾ä¸œä¸‹åˆ 5:00 (UTC-5)
    # - å¤ä»¤æ—¶æœŸé—´ (çº¦3æœˆ-11æœˆ): å¯¹åº”ç¾ä¸œä¸‹åˆ 6:00 (UTC-4)
    - cron: '0 22 * * 1-5'

# å®šä¹‰å…·ä½“è¦æ‰§è¡Œçš„ä»»åŠ¡
jobs:
  build-and-commit:
    # åœ¨ä¸€ä¸ªæœ€æ–°çš„ Ubuntu è™šæ‹ŸæœåŠ¡å™¨ä¸Šè¿è¡Œ
    runs-on: ubuntu-latest

    # æˆäºˆå·¥ä½œæµå†™æƒé™ï¼Œä»¥ä¾¿å°†æ–‡ä»¶æäº¤å›ä»“åº“
    permissions:
      contents: write

    steps:
      # ç¬¬1æ­¥ï¼šå°†æ‚¨çš„ä»£ç ä»“åº“ä¸‹è½½åˆ°è™šæ‹ŸæœåŠ¡å™¨ä¸Š
      - name: Checkout repository
        uses: actions/checkout@v3

      # ç¬¬2æ­¥ï¼šè®¾ç½® Python 3.10 ç¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # ç¬¬3æ­¥ï¼šå®‰è£…è„šæœ¬è¿è¡Œæ‰€éœ€çš„ Python åº“
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "âš ï¸ requirements.txt not found, installing basic dependencies..."
            pip install requests pandas matplotlib numpy yfinance pytz
          fi

      # ç¬¬4æ­¥ï¼šè¿è¡Œä¸»åˆ†æå’Œæ”¶ç›Šè®¡ç®—è„šæœ¬
      - name: Run all data generation scripts
        env:
          ALPHA_API_KEY: ${{ secrets.ALPHA_API_KEY }}
        run: |
          echo "=== Running main.py ==="
          
          if [ -n "${ALPHA_API_KEY}" ]; then
            echo "âœ… Found ALPHA_API_KEY from secrets. Updating config.ini..."
            if grep -q "^api_key" config.ini; then
              sed -i "s/^api_key = .*/api_key = ${ALPHA_API_KEY}/" config.ini
            else
              echo "api_key = ${ALPHA_API_KEY}" >> config.ini
            fi
          else
            echo "âš ï¸ Warning: ALPHA_API_KEY not set. Using existing key in config.ini."
          fi

          # <<< ä¿®æ”¹: ä½¿ç”¨æ–°çš„è„šæœ¬è·¯å¾„ >>>
          python scripts/main.py
          
          echo "=== Running get_asset_performance.py ==="
          python scripts/get_asset_performance.py
          
          echo "=== Running calculate_return.py ==="
          python scripts/calculate_return.py
          
          echo "=== Running CNN_fear_greed_index.py ==="
          python scripts/CNN_fear_greed_index.py

      # ç¬¬5æ­¥ï¼šå°†æ–°ç”Ÿæˆæˆ–æ›´æ–°çš„æ–‡ä»¶æäº¤å›æ‚¨çš„ä»£ç ä»“åº“
      - name: Commit updated data files
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # <<< ä¿®æ”¹: git add å‘½ä»¤æŒ‡å‘ data/ ç›®å½•ä¸‹çš„æ–‡ä»¶ >>>
          git add data/portfolio_details_history.csv data/portfolio_value_chart.png data/portfolio_pie_chart.png data/portfolio_return.json data/portfolio_assets_returns.json data/fear_greed_index.json
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶è¢«ä¿®æ”¹ï¼Œå¦‚æœæœ‰ï¼Œæ‰æ‰§è¡Œæäº¤å’Œæ¨é€
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "ğŸ“Š Automated data, charts, and returns update"
            git push
          fi
